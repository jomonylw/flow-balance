# Vercel æ•°æ®åº“è¿æ¥ä¼˜åŒ–æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

åœ¨ Vercel ç­‰ serverless ç¯å¢ƒä¸­éƒ¨ç½²æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹æ•°æ®åº“è¿æ¥é—®é¢˜ï¼š

```
Error [PrismaClientInitializationError]: Too many database connections opened:
FATAL: too many connections for role "prisma_migration"
```

è¿™æ˜¯å› ä¸ºï¼š

1. **Serverless ç‰¹æ€§**ï¼šæ¯ä¸ªå‡½æ•°è°ƒç”¨å¯èƒ½åˆ›å»ºæ–°çš„æ•°æ®åº“è¿æ¥
2. **è¿æ¥æ± é™åˆ¶**ï¼šå…è´¹ç‰ˆæ•°æ®åº“é€šå¸¸æœ‰è¿æ¥æ•°é™åˆ¶ï¼ˆå¦‚ 10 ä¸ªè¿æ¥ï¼‰
3. **å¹¶å‘è¯·æ±‚**ï¼šå¤šä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿè€—å°½è¿æ¥æ± 

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“è¿æ¥ä¼˜åŒ–

é¡¹ç›®å·²å®ç°ä»¥ä¸‹ä¼˜åŒ–æªæ–½ï¼š

#### è¿æ¥ç®¡ç†å™¨ (`src/lib/database/connection-manager.ts`)

- **å•ä¾‹æ¨¡å¼**ï¼šç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªè¿æ¥ç®¡ç†å™¨å®ä¾‹
- **è¿æ¥æ± é™åˆ¶**ï¼šæœ€å¤§è¿æ¥æ•°è®¾ç½®ä¸º 5ï¼ˆé€‚åˆå…è´¹ç‰ˆæ•°æ®åº“ï¼‰
- **è‡ªåŠ¨æ¸…ç†**ï¼šç©ºé—²è¿æ¥è‡ªåŠ¨æ–­å¼€ï¼ˆ60ç§’è¶…æ—¶ï¼‰
- **è¿æ¥å¤ç”¨**ï¼šåœ¨åŒä¸€ä¸ª serverless å®ä¾‹ä¸­å¤ç”¨è¿æ¥

#### Prisma å®¢æˆ·ç«¯ä¼˜åŒ– (`src/lib/database/prisma.ts`)

- **å…¨å±€å®ä¾‹**ï¼šåœ¨éç”Ÿäº§ç¯å¢ƒä¸­å¤ç”¨å…¨å±€å®ä¾‹
- **è¿æ¥å‚æ•°**ï¼šé’ˆå¯¹ PostgreSQL æ·»åŠ è¿æ¥æ± å‚æ•°
- **ä¼˜é›…å…³é—­**ï¼šè¿›ç¨‹é€€å‡ºæ—¶æ­£ç¡®æ–­å¼€è¿æ¥

### 2. Vercel é…ç½®ä¼˜åŒ–

#### `vercel.json` é…ç½®

```json
{
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 30,
      "memory": 1024,
      "regions": ["iad1"]
    },
    "src/app/**/page.tsx": {
      "maxDuration": 30,
      "memory": 1024,
      "regions": ["iad1"]
    }
  },
  "env": {
    "PRISMA_CLIENT_ENGINE_TYPE": "binary"
  }
}
```

### 3. æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¼˜åŒ–

#### PostgreSQL è¿æ¥å‚æ•°

```bash
# åŸºç¡€è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL="postgresql://user:password@host:port/database"

# ä¼˜åŒ–åçš„è¿æ¥å­—ç¬¦ä¸²ï¼ˆè‡ªåŠ¨æ·»åŠ ï¼‰
DATABASE_URL="postgresql://user:password@host:port/database?connection_limit=3&pool_timeout=10&connect_timeout=10&statement_timeout=30000&idle_in_transaction_session_timeout=60000"
```

å‚æ•°è¯´æ˜ï¼š

- `connection_limit=3`ï¼šæ¯ä¸ªå®ä¾‹æœ€å¤š 3 ä¸ªè¿æ¥
- `pool_timeout=10`ï¼šè¿æ¥æ± è¶…æ—¶ 10 ç§’
- `connect_timeout=10`ï¼šè¿æ¥è¶…æ—¶ 10 ç§’
- `statement_timeout=30000`ï¼šè¯­å¥è¶…æ—¶ 30 ç§’
- `idle_in_transaction_session_timeout=60000`ï¼šç©ºé—²äº‹åŠ¡è¶…æ—¶ 60 ç§’

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. å¥åº·æ£€æŸ¥ API

è®¿é—®ä»¥ä¸‹ç«¯ç‚¹ç›‘æ§æ•°æ®åº“è¿æ¥çŠ¶æ€ï¼š

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl https://your-app.vercel.app/api/health

# è¯¦ç»†æ•°æ®åº“çŠ¶æ€
curl https://your-app.vercel.app/api/health/database
```

### 2. è¿æ¥çŠ¶æ€ç›‘æ§

å¥åº·æ£€æŸ¥ API è¿”å›çš„è¿æ¥ä¿¡æ¯ï¼š

```json
{
  "database": {
    "connectionManager": {
      "connected": true,
      "connectionCount": 2,
      "maxConnections": 5,
      "idleTime": "15s",
      "lastUsed": "2024-07-12T10:30:00.000Z"
    }
  }
}
```

### 3. æ—¥å¿—ç›‘æ§

åœ¨ Vercel æ§åˆ¶å°æŸ¥çœ‹å‡½æ•°æ—¥å¿—ï¼š

```
âœ… Database connection established (2/5)
ğŸ§¹ Cleaned up idle database connection (1/5)
```

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. æ•°æ®åº“æä¾›å•†é€‰æ‹©

**æ¨èçš„å…è´¹æ•°æ®åº“æœåŠ¡**ï¼š

- **Supabase**ï¼šå…è´¹ç‰ˆæä¾› 500MB å­˜å‚¨ï¼Œ100 ä¸ªå¹¶å‘è¿æ¥
- **PlanetScale**ï¼šå…è´¹ç‰ˆæä¾› 5GB å­˜å‚¨ï¼Œ1000 ä¸ªè¿æ¥
- **Neon**ï¼šå…è´¹ç‰ˆæä¾› 512MB å­˜å‚¨ï¼Œ100 ä¸ªè¿æ¥

### 2. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­é…ç½®ï¼š

```bash
DATABASE_URL="your-optimized-connection-string"
JWT_SECRET="your-secure-jwt-secret"
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

### 3. éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²å·²ä¼˜åŒ–
- [ ] Vercel å‡½æ•°é…ç½®å·²æ›´æ–°
- [ ] å¥åº·æ£€æŸ¥ API æ­£å¸¸å“åº”
- [ ] è¿æ¥æ•°ç›‘æ§æ­£å¸¸
- [ ] æ— è¿æ¥æ³„æ¼é”™è¯¯

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥æ•°ä»ç„¶è¶…é™**

   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åº”ç”¨è¿æ¥åŒä¸€æ•°æ®åº“
   - é™ä½ `connection_limit` å‚æ•°
   - è€ƒè™‘å‡çº§æ•°æ®åº“è®¡åˆ’

2. **è¿æ¥è¶…æ—¶**

   - å¢åŠ  `connect_timeout` å’Œ `pool_timeout`
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡å™¨çŠ¶æ€
   - ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®š

3. **æ€§èƒ½é—®é¢˜**
   - ç›‘æ§æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
   - è€ƒè™‘æ·»åŠ ç¼“å­˜å±‚

### è°ƒè¯•å‘½ä»¤

```bash
# æœ¬åœ°æµ‹è¯•è¿æ¥
pnpm db:test

# æ£€æŸ¥ Prisma å®¢æˆ·ç«¯
pnpm db:generate

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
curl -I https://your-app.vercel.app/api/health
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è¿æ¥æ± è°ƒä¼˜**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´è¿æ¥æ•°é™åˆ¶
2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•å’Œä¼˜åŒ–æŸ¥è¯¢è¯­å¥
3. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®æ·»åŠ ç¼“å­˜
4. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®è¿æ¥æ•°å’Œå“åº”æ—¶é—´å‘Šè­¦
5. **å®šæœŸç»´æŠ¤**ï¼šå®šæœŸæ¸…ç†æ— ç”¨è¿æ¥å’Œä¼˜åŒ–æ•°æ®åº“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æªæ–½ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ Vercel éƒ¨ç½²ä¸­çš„æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œç¡®ä¿åº”ç”¨ç¨³å®šè¿è¡Œã€‚
