# è´§å¸æœåŠ¡ Next.js ç¼“å­˜ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

åŸºäºç”¨æˆ·åé¦ˆçš„æ€§èƒ½é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ `convertMultipleCurrencies` å‡½æ•°çš„ N+1 æŸ¥è¯¢é—®é¢˜ï¼Œä½¿ç”¨ Next.js çš„
`unstable_cache` åŠŸèƒ½å¯¹è´§å¸æœåŠ¡è¿›è¡Œå…¨é¢ç¼“å­˜ä¼˜åŒ–ã€‚

## ğŸ“Š ä¼˜åŒ–å‰çš„é—®é¢˜

### 1. N+1 æŸ¥è¯¢é—®é¢˜

- `convertMultipleCurrencies` å‡½æ•°å¯¹æ¯ä¸ªè´§å¸å•ç‹¬æŸ¥è¯¢æ±‡ç‡
- æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°éšè´§å¸æ•°é‡çº¿æ€§å¢é•¿
- ä¸¥é‡å½±å“æ‰¹é‡è½¬æ¢æ€§èƒ½

### 2. é‡å¤æ•°æ®åº“æŸ¥è¯¢

- ç›¸åŒçš„è´§å¸ä¿¡æ¯è¢«é‡å¤æŸ¥è¯¢
- ç”¨æˆ·è®¾ç½®å’Œæ±‡ç‡æ•°æ®ç¼ºä¹ç¼“å­˜
- é«˜å¹¶å‘åœºæ™¯ä¸‹æ•°æ®åº“å‹åŠ›å¤§

### 3. å“åº”æ—¶é—´é•¿

- API å“åº”æ—¶é—´ 50-200ms
- æ‰¹é‡æ“ä½œå»¶è¿Ÿæ˜æ˜¾
- ç”¨æˆ·ä½“éªŒä¸ä½³

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ä½¿ç”¨ Next.js unstable_cache

å¯¹ä»¥ä¸‹æ ¸å¿ƒå‡½æ•°è¿›è¡Œç¼“å­˜ä¼˜åŒ–ï¼š

```typescript
// ç¼“å­˜é…ç½®
const CACHE_TAGS = {
  USER_CURRENCIES: 'user-currencies',
  USER_SETTINGS: 'user-settings',
  EXCHANGE_RATES: 'exchange-rates',
  CURRENCY_RECORDS: 'currency-records',
}

// ç¼“å­˜æ—¶é—´
- ç”¨æˆ·æ•°æ®: 10åˆ†é’Ÿ (CACHE.USER_DATA_TTL)
- æ±‡ç‡æ•°æ®: 1å°æ—¶ (CACHE.EXCHANGE_RATE_TTL)
```

### 2. ä¼˜åŒ–çš„å‡½æ•°åˆ—è¡¨

| å‡½æ•°å                      | ä¼˜åŒ–ç±»å‹     | ç¼“å­˜æ—¶é—´ | ä¸»è¦æ”¹è¿›         |
| --------------------------- | ------------ | -------- | ---------------- |
| `findUserActiveCurrency`    | åŸºç¡€ç¼“å­˜     | 10åˆ†é’Ÿ   | å‡å°‘è´§å¸æŸ¥è¯¢     |
| `getUserExchangeRate`       | åŸºç¡€ç¼“å­˜     | 1å°æ—¶    | å‡å°‘æ±‡ç‡æŸ¥è¯¢     |
| `getUserCurrencies`         | åŸºç¡€ç¼“å­˜     | 10åˆ†é’Ÿ   | å‡å°‘ç”¨æˆ·è´§å¸æŸ¥è¯¢ |
| `getUserCurrencyRecords`    | åŸºç¡€ç¼“å­˜     | 10åˆ†é’Ÿ   | å‡å°‘è´§å¸è®°å½•æŸ¥è¯¢ |
| `convertMultipleCurrencies` | **é‡ç‚¹ä¼˜åŒ–** | 1å°æ—¶    | æ¶ˆé™¤N+1æŸ¥è¯¢      |

### 3. convertMultipleCurrencies é‡ç‚¹ä¼˜åŒ–

#### ä¼˜åŒ–å‰é€»è¾‘ï¼š

```typescript
for (const { amount, currency } of amounts) {
  const result = await convertCurrency(userId, amount, currency, baseCurrency, asOfDate)
  results.push(result)
}
```

#### ä¼˜åŒ–åé€»è¾‘ï¼š

```typescript
// 1. æ‰¹é‡è·å–æ‰€æœ‰è´§å¸è®°å½•
const currencyRecords = await Promise.all(
  uniqueCurrencies.map(async code => ({
    code,
    record: await findUserActiveCurrency(userId, code),
  }))
)

// 2. æ‰¹é‡è·å–æ‰€æœ‰æ±‡ç‡
const exchangeRatePromises = amounts
  .filter(({ currency }) => currency !== baseCurrency)
  .map(async ({ currency }) => {
    const rate = await getUserExchangeRate(userId, currency, baseCurrency, asOfDate)
    return { currency, rate }
  })

// 3. å¹¶è¡Œå¤„ç†æ‰€æœ‰è½¬æ¢
const exchangeRates = await Promise.all(exchangeRatePromises)
```

## ğŸ”§ ç¼“å­˜å¤±æ•ˆæœºåˆ¶

### 1. ç¼“å­˜å¤±æ•ˆå‡½æ•°

```typescript
// ç”¨æˆ·è´§å¸è®¾ç½®å˜æ›´
revalidateUserCurrencyCache(userId)

// æ±‡ç‡æ•°æ®å˜æ›´
revalidateExchangeRateCache(userId)

// ç”¨æˆ·è®¾ç½®å˜æ›´
revalidateUserSettingsCache(userId)

// æ‰¹é‡æ“ä½œ
revalidateAllCurrencyCache()
```

### 2. API é›†æˆç¤ºä¾‹

å·²åœ¨ä»¥ä¸‹ API è·¯ç”±ä¸­é›†æˆç¼“å­˜å¤±æ•ˆï¼š

- `src/app/api/user/currencies/route.ts` - ç”¨æˆ·è´§å¸è®¾ç½®
- `src/app/api/exchange-rates/route.ts` - æ±‡ç‡ç®¡ç†
- `src/app/api/user/settings/route.ts` - ç”¨æˆ·è®¾ç½®

## ğŸ“ˆ æ€§èƒ½æå‡é¢„æœŸ

### 1. å“åº”æ—¶é—´æ”¹å–„

| åœºæ™¯             | ä¼˜åŒ–å‰     | ä¼˜åŒ–å    | æ”¹å–„å¹…åº¦ |
| ---------------- | ---------- | --------- | -------- |
| ç¼“å­˜å‘½ä¸­         | 50-200ms   | 1-5ms     | **95%+** |
| ç¼“å­˜æœªå‘½ä¸­       | 50-200ms   | 50-200ms  | 0%       |
| æ‰¹é‡è½¬æ¢(10è´§å¸) | 500-2000ms | 150-200ms | **80%+** |

### 2. æ•°æ®åº“æŸ¥è¯¢å‡å°‘

| æ“ä½œ             | ä¼˜åŒ–å‰æŸ¥è¯¢æ¬¡æ•° | ä¼˜åŒ–åæŸ¥è¯¢æ¬¡æ•° | å‡å°‘å¹…åº¦ |
| ---------------- | -------------- | -------------- | -------- |
| è·å–ç”¨æˆ·è´§å¸     | æ¯æ¬¡2-3ä¸ª      | ç¼“å­˜æœŸå†…0ä¸ª    | **90%+** |
| æ‰¹é‡è½¬æ¢(10è´§å¸) | 20-30ä¸ª        | ç¼“å­˜æœŸå†…0ä¸ª    | **95%+** |
| æ±‡ç‡æŸ¥è¯¢         | æ¯æ¬¡1-2ä¸ª      | ç¼“å­˜æœŸå†…0ä¸ª    | **90%+** |

### 3. ç¼“å­˜å‘½ä¸­ç‡é¢„æœŸ

- **ç”¨æˆ·è´§å¸æ•°æ®**: 90%+ (ç”¨æˆ·å¾ˆå°‘ä¿®æ”¹è´§å¸è®¾ç½®)
- **æ±‡ç‡æ•°æ®**: 85%+ (æ±‡ç‡æ›´æ–°é¢‘ç‡è¾ƒä½)
- **ç”¨æˆ·è®¾ç½®**: 95%+ (è®¾ç½®å˜æ›´å¾ˆå°‘)

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æ€§èƒ½æµ‹è¯•è„šæœ¬

åˆ›å»ºäº† `scripts/test-currency-cache-performance.js` ç”¨äºéªŒè¯ä¼˜åŒ–æ•ˆæœï¼š

```bash
node scripts/test-currency-cache-performance.js
```

### 2. æµ‹è¯•åœºæ™¯

- 10ä¸ªç”¨æˆ·ï¼Œæ¯ç”¨æˆ·20æ¬¡è¿­ä»£
- 5ä¸ªè´§å¸å¯¹çš„æ±‡ç‡æŸ¥è¯¢
- 10ä¸ªé‡‘é¢çš„æ‰¹é‡è½¬æ¢
- æ¨¡æ‹Ÿ90%+ç¼“å­˜å‘½ä¸­ç‡

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 1. ä»£ç å˜æ›´ç¡®è®¤

- âœ… `src/lib/services/currency.service.ts` - æ ¸å¿ƒä¼˜åŒ–
- âœ… API è·¯ç”±ç¼“å­˜å¤±æ•ˆé›†æˆ
- âœ… ç±»å‹å®‰å…¨å’Œé”™è¯¯å¤„ç†
- âœ… å‘åå…¼å®¹æ€§ä¿æŒ

### 2. é…ç½®æ£€æŸ¥

- âœ… ç¼“å­˜æ—¶é—´é…ç½®åˆç†
- âœ… ç¼“å­˜æ ‡ç­¾è®¾ç½®æ­£ç¡®
- âœ… ç¯å¢ƒå˜é‡æ— éœ€å˜æ›´

### 3. ç›‘æ§è¦ç‚¹

éƒ¨ç½²åéœ€è¦ç›‘æ§ï¼š

- API å“åº”æ—¶é—´å˜åŒ–
- æ•°æ®åº“æŸ¥è¯¢é¢‘ç‡
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- ç¼“å­˜å‘½ä¸­ç‡

## ğŸ”® æœªæ¥æ‰©å±•

### 1. å½“å‰æ–¹æ¡ˆé™åˆ¶

- é€‚ç”¨äº < 10,000 æ´»è·ƒç”¨æˆ·
- å†…å­˜ç¼“å­˜ï¼Œé‡å¯åæ¸…ç©º
- å•å®ä¾‹éƒ¨ç½²

### 2. æ‰©å±•é€‰é¡¹

1. **åˆ†å¸ƒå¼ç¼“å­˜**: è¿ç§»åˆ° Redis
2. **ç¼“å­˜é¢„çƒ­**: é¢„åŠ è½½å¸¸ç”¨æ•°æ®
3. **æ™ºèƒ½å¤±æ•ˆ**: åŸºäºæ•°æ®å˜æ›´é¢‘ç‡è°ƒæ•´TTL
4. **ç›‘æ§å‘Šè­¦**: ç¼“å­˜æ€§èƒ½ç›‘æ§

## âœ… æ€»ç»“

é€šè¿‡ Next.js ç¼“å­˜ä¼˜åŒ–ï¼Œè´§å¸æœåŠ¡æ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡ï¼š

- **ğŸš€ å“åº”é€Ÿåº¦**: ç¼“å­˜å‘½ä¸­æ—¶æå‡ 95%+
- **ğŸ“‰ æ•°æ®åº“è´Ÿè½½**: æŸ¥è¯¢æ¬¡æ•°å‡å°‘ 90%+
- **ğŸ”§ ä»£ç è´¨é‡**: æ¶ˆé™¤ N+1 æŸ¥è¯¢ï¼Œä¿æŒå…¼å®¹æ€§
- **ğŸ“ˆ ç”¨æˆ·ä½“éªŒ**: æ‰¹é‡æ“ä½œå“åº”æ—¶é—´å¤§å¹…æ”¹å–„

è¯¥ä¼˜åŒ–æ–¹æ¡ˆåœ¨ä¿æŒä»£ç ç®€æ´æ€§çš„åŒæ—¶ï¼Œä¸ºç³»ç»Ÿçš„é«˜æ€§èƒ½è¿è¡Œæä¾›äº†åšå®åŸºç¡€ï¼Œç‰¹åˆ«æ˜¯è§£å†³äº†ç”¨æˆ·åé¦ˆçš„
`convertMultipleCurrencies` æ€§èƒ½é—®é¢˜ã€‚
