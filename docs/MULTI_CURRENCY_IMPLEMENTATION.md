# Flow Balance - å¤šè´§å¸æ±‡ç‡åŠŸèƒ½å®ç°

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†Flow
Balanceé¡¹ç›®ä¸­å¤šè´§å¸æ±‡ç‡ç®¡ç†åŠŸèƒ½çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬æ‰‹å·¥å½•å…¥æ±‡ç‡ã€è‡ªåŠ¨è´§å¸è½¬æ¢å’Œæœ¬ä½å¸ç»Ÿè®¡ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ“‹ éœ€æ±‚åˆ†æ

### ç”¨æˆ·éœ€æ±‚

1. **æ‰‹å·¥å½•å…¥æ±‡ç‡åŠŸèƒ½** - æ ¹æ®ç›®å‰ä½¿ç”¨çš„è´§å¸ï¼Œè®¾ç½®ä¸ºå¿…é¡»è¾“å…¥
2. **æ‰€æœ‰æ±‡æ€»é¢æ¿ç»Ÿè®¡æŠ˜åˆæˆæœ¬ä½å¸æ˜¾ç¤º** - é‡æ–°æ£€æŸ¥å¹¶ä¿®æ­£è®¡ç®—é€»è¾‘
3. **é‡æ–°æ¢³ç†æ•´ä¸ªä¸šåŠ¡æµç¨‹** - ç¡®ä¿æµç¨‹ç•…é¡º

### æŠ€æœ¯éœ€æ±‚

- æ”¯æŒå¤šè´§å¸äº¤æ˜“è®°å½•
- ç”¨æˆ·è‡ªå®šä¹‰æ±‡ç‡ç®¡ç†
- å®æ—¶è´§å¸è½¬æ¢
- æœ¬ä½å¸ç»Ÿä¸€æ˜¾ç¤º
- æ±‡ç‡ç¼ºå¤±æé†’

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•°æ®æ¨¡å‹

#### 1. æ±‡ç‡è¡¨ (ExchangeRate)

```prisma
model ExchangeRate {
  id           String   @id @default(cuid())
  userId       String
  fromCurrency String   // æºè´§å¸ä»£ç 
  toCurrency   String   // ç›®æ ‡è´§å¸ä»£ç 
  rate         Decimal  // æ±‡ç‡ï¼Œä½¿ç”¨ Decimal ç±»å‹ç¡®ä¿ç²¾åº¦
  effectiveDate DateTime // æ±‡ç‡ç”Ÿæ•ˆæ—¥æœŸ
  notes        String?  // å¤‡æ³¨
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // å…³è”å…³ç³»
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromCurrencyRef Currency @relation("FromCurrency", fields: [fromCurrency], references: [code])
  toCurrencyRef   Currency @relation("ToCurrency", fields: [toCurrency], references: [code])

  // ç¡®ä¿åŒä¸€ç”¨æˆ·çš„åŒä¸€è´§å¸å¯¹åœ¨åŒä¸€æ—¥æœŸåªæœ‰ä¸€ä¸ªæ±‡ç‡
  @@unique([userId, fromCurrency, toCurrency, effectiveDate])
  @@map("exchange_rates")
}
```

#### 2. è´§å¸è¡¨æ›´æ–°

```prisma
model Currency {
  // ... åŸæœ‰å­—æ®µ
  fromExchangeRates ExchangeRate[] @relation("FromCurrency")
  toExchangeRates   ExchangeRate[] @relation("ToCurrency")
}
```

### æ ¸å¿ƒæœåŠ¡

#### 1. è´§å¸è½¬æ¢æœåŠ¡ (`src/lib/currency-conversion.ts`)

- `getUserExchangeRate()` - è·å–ç”¨æˆ·æ±‡ç‡è®¾ç½®
- `convertCurrency()` - å•ä¸ªé‡‘é¢è½¬æ¢
- `convertMultipleCurrencies()` - æ‰¹é‡é‡‘é¢è½¬æ¢
- `getUserCurrencies()` - è·å–ç”¨æˆ·ä½¿ç”¨çš„è´§å¸
- `getMissingExchangeRates()` - æ£€æŸ¥ç¼ºå¤±çš„æ±‡ç‡

#### 2. å¢å¼ºçš„ä½™é¢è®¡ç®— (`src/lib/account-balance.ts`)

- `calculateAccountBalanceWithConversion()` - å¸¦è½¬æ¢çš„è´¦æˆ·ä½™é¢è®¡ç®—
- `calculateTotalBalanceWithConversion()` - å¸¦è½¬æ¢çš„æ±‡æ€»ä½™é¢è®¡ç®—

## ğŸ”§ API æ¥å£

### æ±‡ç‡ç®¡ç† API

#### 1. è·å–æ±‡ç‡åˆ—è¡¨

```
GET /api/exchange-rates
Query: fromCurrency?, toCurrency?
```

#### 2. åˆ›å»º/æ›´æ–°æ±‡ç‡

```
POST /api/exchange-rates
Body: {
  fromCurrency: string,
  toCurrency: string,
  rate: number,
  effectiveDate: string,
  notes?: string
}
```

#### 3. æ‰¹é‡åˆ›å»ºæ±‡ç‡

```
PUT /api/exchange-rates
Body: {
  rates: Array<ExchangeRateData>
}
```

#### 4. å•ä¸ªæ±‡ç‡æ“ä½œ

```
GET /api/exchange-rates/[id]     - è·å–è¯¦æƒ…
PUT /api/exchange-rates/[id]     - æ›´æ–°æ±‡ç‡
DELETE /api/exchange-rates/[id]  - åˆ é™¤æ±‡ç‡
```

#### 5. ç¼ºå¤±æ±‡ç‡æ£€æŸ¥

```
GET /api/exchange-rates/missing
Response: {
  baseCurrency: Currency,
  missingRates: Array<MissingRateInfo>,
  existingRates: Array<ExchangeRateData>,
  summary: {
    totalCurrencies: number,
    missingRatesCount: number,
    needsAttention: boolean
  }
}
```

## ğŸ¨ å‰ç«¯ç»„ä»¶

### 1. æ±‡ç‡ç®¡ç†ç»„ä»¶

- `ExchangeRateManagement.tsx` - ä¸»ç®¡ç†ç•Œé¢
- `ExchangeRateForm.tsx` - æ±‡ç‡è¡¨å•
- `ExchangeRateList.tsx` - æ±‡ç‡åˆ—è¡¨

### 2. æé†’ç»„ä»¶

- `ExchangeRateAlert.tsx` - Dashboardæ±‡ç‡ç¼ºå¤±æé†’
- `CurrencyConversionStatus.tsx` - è´§å¸è½¬æ¢çŠ¶æ€æ˜¾ç¤º

### 3. è®¾ç½®é›†æˆ

- åœ¨ç”¨æˆ·è®¾ç½®ä¸­æ·»åŠ "æ±‡ç‡ç®¡ç†"æ ‡ç­¾é¡µ
- æ”¯æŒURLå‚æ•°ç›´æ¥è·³è½¬åˆ°æ±‡ç‡è®¾ç½®

## ğŸ’¡ æ ¸å¿ƒåŠŸèƒ½

### 1. æ™ºèƒ½æ±‡ç‡æ£€æµ‹

- è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·ä½¿ç”¨çš„è´§å¸
- è¯†åˆ«ç¼ºå¤±çš„æ±‡ç‡è®¾ç½®
- åœ¨Dashboardæ˜¾ç¤ºæé†’

### 2. å®æ—¶è´§å¸è½¬æ¢

- æ‰€æœ‰ç»Ÿè®¡æ•°æ®è‡ªåŠ¨è½¬æ¢ä¸ºæœ¬ä½å¸
- æ”¯æŒæ‰¹é‡è½¬æ¢ä¼˜åŒ–æ€§èƒ½
- è½¬æ¢å¤±è´¥æ—¶çš„é™çº§å¤„ç†

### 3. ç”¨æˆ·å‹å¥½çš„æ±‡ç‡ç®¡ç†

- ç›´è§‚çš„æ±‡ç‡è®¾ç½®ç•Œé¢
- æ”¯æŒæ‰¹é‡å¯¼å…¥æ±‡ç‡
- æ±‡ç‡å†å²è®°å½•ç®¡ç†

### 4. æ•°æ®ä¸€è‡´æ€§ä¿è¯

- æ±‡ç‡ç²¾åº¦ä½¿ç”¨Decimalç±»å‹
- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ±‡ç‡
- äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®å®Œæ•´æ€§

## ğŸ“Š æ›´æ–°çš„ç»Ÿè®¡é€»è¾‘

### 1. Dashboardæ±‡æ€»

- å‡€èµ„äº§è®¡ç®—æ”¯æŒå¤šè´§å¸è½¬æ¢
- æ”¶æ”¯ç»Ÿè®¡è½¬æ¢ä¸ºæœ¬ä½å¸æ˜¾ç¤º
- å›¾è¡¨æ•°æ®ç»Ÿä¸€ä½¿ç”¨æœ¬ä½å¸

### 2. è´¢åŠ¡æŠ¥è¡¨

- èµ„äº§è´Ÿå€ºè¡¨æ”¯æŒå¤šè´§å¸
- ç°é‡‘æµé‡è¡¨æ”¯æŒå¤šè´§å¸
- æ‰€æœ‰é‡‘é¢ç»Ÿä¸€è½¬æ¢æ˜¾ç¤º

### 3. è´¦æˆ·è¯¦æƒ…

- æ˜¾ç¤ºåŸå§‹è´§å¸å’Œè½¬æ¢åé‡‘é¢
- æ±‡ç‡ä¿¡æ¯é€æ˜å±•ç¤º
- è½¬æ¢é”™è¯¯çŠ¶æ€æç¤º

## ğŸ”„ ä¸šåŠ¡æµç¨‹ä¼˜åŒ–

### 1. æ–°ç”¨æˆ·å¼•å¯¼

1. ç”¨æˆ·æ·»åŠ å¤šè´§å¸äº¤æ˜“
2. ç³»ç»Ÿæ£€æµ‹ç¼ºå¤±æ±‡ç‡
3. Dashboardæ˜¾ç¤ºè®¾ç½®æé†’
4. å¼•å¯¼ç”¨æˆ·è®¾ç½®æ±‡ç‡
5. ç»Ÿè®¡æ•°æ®æ­£ç¡®æ˜¾ç¤º

### 2. æ—¥å¸¸ä½¿ç”¨æµç¨‹

1. ç”¨æˆ·è®°å½•äº¤æ˜“ï¼ˆä»»æ„è´§å¸ï¼‰
2. ç³»ç»Ÿè‡ªåŠ¨è½¬æ¢ä¸ºæœ¬ä½å¸
3. ç»Ÿè®¡é¢æ¿æ˜¾ç¤ºè½¬æ¢åæ•°æ®
4. æä¾›åŸå§‹é‡‘é¢å‚è€ƒä¿¡æ¯

### 3. æ±‡ç‡ç»´æŠ¤æµç¨‹

1. å®šæœŸæ£€æŸ¥æ±‡ç‡æœ‰æ•ˆæ€§
2. æ›´æ–°è¿‡æœŸæ±‡ç‡
3. æ‰¹é‡å¯¼å…¥æ–°æ±‡ç‡
4. éªŒè¯è½¬æ¢ç»“æœå‡†ç¡®æ€§

## ğŸ§ª æµ‹è¯•æ•°æ®

### ç¤ºä¾‹æ±‡ç‡è®¾ç½®

```javascript
const sampleRates = [
  { fromCurrency: 'EUR', toCurrency: 'USD', rate: 1.08 },
  { fromCurrency: 'CNY', toCurrency: 'USD', rate: 0.14 },
  { fromCurrency: 'JPY', toCurrency: 'USD', rate: 0.0067 },
]
```

### å¤šè´§å¸äº¤æ˜“ç¤ºä¾‹

- USD: å·¥èµ„æ”¶å…¥ã€æ—¥å¸¸æ”¯å‡º
- EUR: æ¬§æ´²é¡¹ç›®æ”¶å…¥
- CNY: ä¸­å›½åœ°åŒºæ¶ˆè´¹
- JPY: æ—¥æœ¬æŠ•èµ„æ”¶ç›Š

## âœ… å®ç°çŠ¶æ€

### å·²å®ŒæˆåŠŸèƒ½

- âœ… æ±‡ç‡æ•°æ®æ¨¡å‹è®¾è®¡
- âœ… æ±‡ç‡ç®¡ç†APIæ¥å£
- âœ… è´§å¸è½¬æ¢æœåŠ¡
- âœ… æ±‡ç‡ç®¡ç†ç•Œé¢
- âœ… Dashboardé›†æˆæé†’
- âœ… ç»Ÿè®¡æ•°æ®è½¬æ¢
- âœ… ç§å­æ•°æ®æ”¯æŒ

### å¾…ä¼˜åŒ–åŠŸèƒ½

- ğŸ”„ æ±‡ç‡è‡ªåŠ¨æ›´æ–°
- ğŸ”„ æ±‡ç‡å†å²å›¾è¡¨
- ğŸ”„ æ‰¹é‡æ±‡ç‡å¯¼å…¥
- ğŸ”„ æ±‡ç‡æœ‰æ•ˆæœŸæé†’

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡å®ç°ï¼ŒFlow Balanceç°åœ¨å®Œå…¨æ”¯æŒå¤šè´§å¸ç®¡ç†ï¼š

1. **ç”¨æˆ·ä½“éªŒ**ï¼šæ™ºèƒ½æ£€æµ‹ç¼ºå¤±æ±‡ç‡ï¼Œå¼•å¯¼ç”¨æˆ·è®¾ç½®
2. **æ•°æ®å‡†ç¡®æ€§**ï¼šæ‰€æœ‰ç»Ÿè®¡æ•°æ®ç»Ÿä¸€è½¬æ¢ä¸ºæœ¬ä½å¸æ˜¾ç¤º
3. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šä»æ±‡ç‡è®¾ç½®åˆ°æ•°æ®å±•ç¤ºçš„å®Œæ•´é—­ç¯
4. **æ‰©å±•æ€§**ï¼šæ”¯æŒä»»æ„è´§å¸å¯¹çš„æ±‡ç‡è®¾ç½®å’Œè½¬æ¢

è¿™ä¸ªå®ç°ä¸ºFlow Balanceçš„å›½é™…åŒ–ä½¿ç”¨å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾ç®¡ç†å¤šè´§å¸çš„ä¸ªäººè´¢åŠ¡æ•°æ®ã€‚
