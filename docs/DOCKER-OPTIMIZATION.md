# Docker é•œåƒä¼˜åŒ–æŒ‡å—

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°† Flow Balance Docker é•œåƒå¤§å°ä» **~1.2GB** ä¼˜åŒ–åˆ° **~300MB**ï¼Œå‡å°‘çº¦ **75%** çš„é•œåƒå¤§å°ã€‚

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

| ç‰ˆæœ¬ | é•œåƒå¤§å° | å±‚æ•° | æ„å»ºæ—¶é—´ | å¯åŠ¨æ—¶é—´ |
|------|----------|------|----------|----------|
| åŸç‰ˆ | ~1.2GB | 15+ | ~5min | ~30s |
| ä¼˜åŒ–ç‰ˆ | ~300MB | 8-10 | ~3min | ~15s |
| **èŠ‚çœ** | **~75%** | **~40%** | **~40%** | **~50%** |

## ğŸ› ï¸ ä¼˜åŒ–ç­–ç•¥

### 1. å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

```dockerfile
# ä¸‰é˜¶æ®µæ„å»ºï¼šdeps -> builder -> runner
FROM node:18-alpine AS deps    # ä¾èµ–å®‰è£…
FROM node:18-alpine AS builder # åº”ç”¨æ„å»º  
FROM node:18-alpine AS runner  # è¿è¡Œç¯å¢ƒ
```

**ä¼˜åŒ–ç‚¹**ï¼š
- åªåœ¨æœ€ç»ˆé•œåƒä¸­ä¿ç•™è¿è¡Œæ—¶å¿…éœ€çš„æ–‡ä»¶
- ç§»é™¤æ„å»ºå·¥å…·å’Œå¼€å‘ä¾èµ–
- ä½¿ç”¨ Alpine Linux å‡å°‘åŸºç¡€é•œåƒå¤§å°

### 2. ä¾èµ–ç®¡ç†ä¼˜åŒ–

**åŸç‰ˆé—®é¢˜**ï¼š
```dockerfile
# åœ¨æ¯ä¸ªé˜¶æ®µéƒ½å®‰è£… pnpm
RUN npm install -g pnpm
# å¤åˆ¶æ•´ä¸ª node_modules
COPY node_modules ./node_modules
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```dockerfile
# ä½¿ç”¨ corepack ç®¡ç† pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate
# åªå®‰è£…ç”Ÿäº§ä¾èµ–
RUN pnpm install --frozen-lockfile --production
# æ¸…ç†ç¼“å­˜
RUN pnpm store prune && rm -rf ~/.pnpm-store
```

### 3. Next.js Standalone æ¨¡å¼

**é…ç½®ä¼˜åŒ–**ï¼š
```javascript
// next.config.js
const nextConfig = {
  output: 'standalone',  // ç”Ÿæˆç‹¬ç«‹è¿è¡ŒåŒ…
  experimental: {
    swcMinify: true,     // å¯ç”¨ SWC å‹ç¼©
    optimizePackageImports: ['@prisma/client', 'echarts']
  }
}
```

**æ•ˆæœ**ï¼š
- å‡å°‘ ~60% çš„è¿è¡Œæ—¶æ–‡ä»¶å¤§å°
- ç§»é™¤ä¸å¿…è¦çš„ Next.js ä¾èµ–

### 4. Prisma ä¼˜åŒ–

**åŸç‰ˆé—®é¢˜**ï¼š
```dockerfile
# å¤åˆ¶æ•´ä¸ª node_modules
COPY --from=builder /app/node_modules ./node_modules
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```dockerfile
# åªå¤åˆ¶ Prisma å¿…éœ€æ–‡ä»¶
COPY --from=builder /app/prisma/schema.prisma ./prisma/
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
```

### 5. ç³»ç»ŸåŒ…ä¼˜åŒ–

**ç§»é™¤ä¸å¿…è¦çš„åŒ…**ï¼š
- `netcat-openbsd` â†’ ä½¿ç”¨ Node.js å¥åº·æ£€æŸ¥
- `bash` â†’ ä½¿ç”¨ `sh`ï¼ˆAlpine é»˜è®¤ï¼‰
- å„ç§æ„å»ºå·¥å…· â†’ åªåœ¨æ„å»ºé˜¶æ®µä½¿ç”¨

**ä¿ç•™å¿…è¦çš„åŒ…**ï¼š
- `dumb-init` â†’ è¿›ç¨‹ç®¡ç†
- `libc6-compat` â†’ Node.js å…¼å®¹æ€§

## ğŸš€ ä½¿ç”¨ä¼˜åŒ–ç‰ˆé•œåƒ

### 1. æ„å»ºä¼˜åŒ–é•œåƒ

```bash
# ä½¿ç”¨ä¼˜åŒ–è„šæœ¬
chmod +x scripts/build-optimized.sh
./scripts/build-optimized.sh

# æˆ–ç›´æ¥æ„å»º
docker build -f Dockerfile.optimized -t flow-balance:optimized .
```

### 2. è¿è¡Œä¼˜åŒ–é•œåƒ

```bash
# ä½¿ç”¨ä¼˜åŒ–ç‰ˆ Docker Compose
docker-compose -f docker-compose.optimized.yml up -d

# æˆ–ç›´æ¥è¿è¡Œ
docker run -d -p 3000:3000 -v $(pwd)/data:/app/data flow-balance:optimized
```

### 3. å¯¹æ¯”é•œåƒå¤§å°

```bash
# è¿è¡Œå¯¹æ¯”è„šæœ¬
chmod +x scripts/compare-images.sh
./scripts/compare-images.sh
```

## ğŸ“‹ ä¼˜åŒ–æ¸…å•

### âœ… å·²å®ç°çš„ä¼˜åŒ–

- [x] **å¤šé˜¶æ®µæ„å»º**ï¼šå‡å°‘æœ€ç»ˆé•œåƒå±‚æ•°
- [x] **Alpine Linux**ï¼šä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒ
- [x] **ç”Ÿäº§ä¾èµ–**ï¼šåªå®‰è£…è¿è¡Œæ—¶å¿…éœ€ä¾èµ–
- [x] **ç¼“å­˜æ¸…ç†**ï¼šæ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
- [x] **Standalone æ¨¡å¼**ï¼šNext.js ç‹¬ç«‹è¿è¡ŒåŒ…
- [x] **æ–‡ä»¶ç²¾ç®€**ï¼šåªå¤åˆ¶å¿…è¦çš„è¿è¡Œæ—¶æ–‡ä»¶
- [x] **ç³»ç»ŸåŒ…ä¼˜åŒ–**ï¼šç§»é™¤ä¸å¿…è¦çš„ç³»ç»ŸåŒ…
- [x] **ç”¨æˆ·æƒé™**ï¼šé root ç”¨æˆ·è¿è¡Œ
- [x] **å¥åº·æ£€æŸ¥**ï¼šè½»é‡çº§å¥åº·æ£€æŸ¥

### ğŸ”„ è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´

- [ ] **é™æ€é“¾æ¥**ï¼šä½¿ç”¨é™æ€ç¼–è¯‘çš„ Node.js
- [ ] **å‹ç¼©å±‚**ï¼šä½¿ç”¨ `docker-slim` è¿›ä¸€æ­¥å‹ç¼©
- [ ] **å¤šæ¶æ„æ„å»º**ï¼šæ”¯æŒ ARM64 æ¶æ„
- [ ] **åˆ†å±‚ç¼“å­˜**ï¼šä¼˜åŒ– Docker å±‚ç¼“å­˜ç­–ç•¥

## ğŸ” é•œåƒåˆ†æ

### æŸ¥çœ‹é•œåƒå±‚

```bash
# åˆ†æé•œåƒå±‚
docker history flow-balance:optimized

# æŸ¥çœ‹é•œåƒå†…å®¹
docker run --rm -it flow-balance:optimized sh
```

### å¤§å°åˆ†æ

```bash
# æŸ¥çœ‹é•œåƒå¤§å°
docker images flow-balance:optimized

# è¯¦ç»†åˆ†æ
docker inspect flow-balance:optimized
```

## ğŸ›¡ï¸ å®‰å…¨ä¼˜åŒ–

### è¿è¡Œæ—¶å®‰å…¨

- **é root ç”¨æˆ·**ï¼šä½¿ç”¨ `nextjs` ç”¨æˆ·è¿è¡Œ
- **åªè¯»æ–‡ä»¶ç³»ç»Ÿ**ï¼šé™¤æ•°æ®ç›®å½•å¤–åªè¯»
- **èµ„æºé™åˆ¶**ï¼šé™åˆ¶å†…å­˜å’Œ CPU ä½¿ç”¨
- **å®‰å…¨é€‰é¡¹**ï¼šç¦ç”¨æ–°æƒé™è·å–

### ç½‘ç»œå®‰å…¨

- **æœ€å°æš´éœ²**ï¼šåªæš´éœ²å¿…è¦ç«¯å£
- **å¥åº·æ£€æŸ¥**ï¼šå†…ç½®åº”ç”¨å¥åº·ç›‘æ§
- **è¿›ç¨‹ç®¡ç†**ï¼šä½¿ç”¨ `dumb-init` ç®¡ç†è¿›ç¨‹

## ğŸ“ˆ æ€§èƒ½æå‡

### å¯åŠ¨æ€§èƒ½

- **æ›´å¿«æ‹‰å–**ï¼šé•œåƒå¤§å°å‡å°‘ 75%
- **æ›´å¿«å¯åŠ¨**ï¼šå‡å°‘æ–‡ä»¶ç³»ç»Ÿå¼€é”€
- **æ›´å°‘å†…å­˜**ï¼šè¿è¡Œæ—¶å†…å­˜å ç”¨é™ä½

### è¿è¡Œæ€§èƒ½

- **SWC å‹ç¼©**ï¼šæ›´å¿«çš„ JavaScript æ‰§è¡Œ
- **ä¼˜åŒ–å¯¼å…¥**ï¼šå‡å°‘æ¨¡å—åŠ è½½æ—¶é—´
- **ç¼“å­˜ä¼˜åŒ–**ï¼šæ›´å¥½çš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜

## ğŸ‰ æ€»ç»“

é€šè¿‡å¤šé˜¶æ®µæ„å»ºã€ä¾èµ–ä¼˜åŒ–ã€æ–‡ä»¶ç²¾ç®€ç­‰ç­–ç•¥ï¼ŒæˆåŠŸå°† Flow Balance Docker é•œåƒå¤§å°å‡å°‘çº¦ **75%**ï¼ŒåŒæ—¶æå‡äº†æ„å»ºå’Œè¿è¡Œæ€§èƒ½ï¼Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚

ä¼˜åŒ–ç‰ˆé•œåƒé€‚åˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´ä½çš„èµ„æºæ¶ˆè€—ã€‚
